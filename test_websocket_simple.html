<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status">Disconnected</div>
    <div id="messages"></div>
    <button onclick="connect()">Connect</button>
    <button onclick="subscribe()">Subscribe to C5 Northbound</button>
    <button onclick="disconnect()">Disconnect</button>

    <script>
        let stompClient = null;
        let sessionId = null;

        function connect() {
            const socket = new SockJS('http://localhost:8080/ws/bus-updates');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                document.getElementById('status').innerHTML = 'Connected: ' + frame;
                console.log('Connected: ' + frame);
                
                // Extract session ID from frame headers
                sessionId = frame.headers['session'];
                console.log('Session ID: ' + sessionId);
            }, function (error) {
                document.getElementById('status').innerHTML = 'Error: ' + error;
                console.log('Error: ' + error);
            });
        }

        function subscribe() {
            if (stompClient && stompClient.connected) {
                // Subscribe to the topic first
                stompClient.subscribe('/topic/bus/C5_Northbound', function (message) {
                    console.log('Received message: ' + message.body);
                    const div = document.createElement('div');
                    div.innerHTML = 'Bus Data: ' + message.body;
                    document.getElementById('messages').appendChild(div);
                });

                // Subscribe to subscription status
                stompClient.subscribe('/topic/bus/subscription-status', function (message) {
                    console.log('Subscription status: ' + message.body);
                    const div = document.createElement('div');
                    div.innerHTML = 'Status: ' + message.body;
                    document.getElementById('messages').appendChild(div);
                });

                // Send subscription request
                stompClient.send('/app/subscribe', {}, JSON.stringify({
                    busNumber: 'C5',
                    direction: 'Northbound',
                    busStopIndex: 8,
                    latitude: -26.180858976522305,
                    longitude: 27.978765964508057
                }));

                console.log('Subscription request sent');
            } else {
                console.log('Not connected');
            }
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            document.getElementById('status').innerHTML = 'Disconnected';
            console.log('Disconnected');
        }
    </script>
</body>
</html>